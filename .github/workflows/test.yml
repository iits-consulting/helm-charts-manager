name: test
on:
  - push
  - pull_request
jobs:
  test:
    name: Minikube-Kubernetes Cluster setup for testing
    runs-on: ubuntu-latest
    env:
      MINIKUBE_VERSION: v1.13.1
      KUBERNETES_VERSION: v1.19.2
      HELM_VERSION: v3.2.1
      HELM_DIFF_PLUGIN_VERSION: v3.1.2
    steps:
      - name: Setup Minikube
        uses: manusa/actions-setup-minikube@v2.0.1
        with:
          minikube version: ${{ env.MINIKUBE_VERSION }}
          kubernetes version: ${{ env.KUBERNETES_VERSION }}
          github token: ${{ secrets.GITHUB_TOKEN }}
      - name: setup helm
        run: |
          curl -L https://get.helm.sh/helm-${{ env.HELM_VERSION }}-linux-amd64.tar.gz -o helm-${{ env.HELM_VERSION }}-linux-amd64.tar.gz &&
          tar -xzf helm-${{ env.HELM_VERSION }}-linux-amd64.tar.gz &&
          sudo mv linux-amd64/helm /usr/local/bin/helm && rm -rf linux-amd64 &&
          rm -rf helm-${{ env.HELM_VERSION }}-linux-amd64.tar.gz
      - name: setup helm diff
        run: helm plugin install https://github.com/databus23/helm-diff --version ${{ env.HELM_DIFF_PLUGIN_VERSION }}
      - name: Set up Go 1.x
        uses: actions/setup-go@v2
        with:
          go-version: ^1.13
      - name: Checkout
        uses: actions/checkout@v2
      - name: Get dependencies
        run: |
          go get -v -t -d ./...
          if [ -f Gopkg.toml ]; then
              curl https://raw.githubusercontent.com/golang/dep/master/install.sh | sh
              dep ensure
          fi
      - name: Build
        run: go build -v .
      - name: Test
        run: go test system_test.go -v

